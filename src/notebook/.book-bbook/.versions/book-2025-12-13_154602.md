# Accueil

```julia (editor=true, logging=false, output=true)
import Pkg 
Pkg.add("Gtk")
```
```julia (editor=true, logging=false, output=true)
using Makie, WGLMakie, Gtk, JSON3, DataFrames

# Dialogue sélection du fichier
#file_path = open_dialog("Sélectionnez un fichier Spotify (JSON)")
#file_path === nothing && error("Aucun fichier sélectionné.")
# Lecture fichier
#txt = read(file_path, String)
#txt = strip(txt)
txt = "examples/data/History_files/Streaming_History_Audio_2025_4.json"
# Parse JSON
data = JSON3.read(txt)
# Conversion en dataframe
rows = [Dict{Symbol,Any}(Symbol(k) => v for (k, v) in pairs(obj)) for obj in data]
df = DataFrame(rows)

# Séparation de la date et de l'heure
using Dates
# Conversion en DateTime
df.date_time_parsed = DateTime.(df.ts, dateformat"yyyy-mm-ddTHH:MM:SSZ")
# Séparation en deux colonnes
df.date = Date.(df.date_time_parsed)
df.time = Time.(df.date_time_parsed)

first(df, 2)
```
```julia (editor=true, logging=false, output=false)
df = select(df, 
:master_metadata_track_name => :track_name, 
:master_metadata_album_album_name => :album,
:master_metadata_album_artist_name => :artist,
:date, :time,
:ms_played,
:skipped,
:reason_end,
:shuffle
)
```
```julia (editor=true, logging=false, output=true)
first(df, 2)
```
# Temps d'écoute

## 0. Statistiques globales (minutes, heures, jours) (KPI)

```julia (editor=true, logging=false, output=true)
tps_min = sum(df.ms_played) / 60000  # en minutes
tps_h = tps_min / 60
tps_j = tps_h / 24
```
## 1. Répartition sur les mois (bar chart)

## 2. Répartition sur les jours de la semaine (bar chart)

## 3. Répartition sur les heures de la journée (rose des vents)

# Statistiques sur les titres

## 1. Nombre de titres écoutés

```julia (editor=true, logging=false, output=true)
length(df.track_name)
```
## 2. Nombre de titres uniques écoutés

```julia (editor=true, logging=false, output=true)
length(unique(df.track_name))
```
## 3. Top écoute (annuel et mensuel avec bubble chart)

```julia (editor=true, logging=false, output=true)
#compter pour chaque titre le nombre d'écoutes
df_counts = combine(groupby(df, :track_name), nrow => :count)
#trier par nombre d'écoutes décroissant
sort!(df_counts, :count, rev=true)
#sélectionner les 10 titres les plus écoutés
top10 = df_counts[1:10, :]
```
```julia (editor=true, logging=false, output=true)
using WGLMakie

# Données
n = 10 # Nombre de musiques
x = rand(n)
y = rand(n)
positions = Point2f.(x_jittered, y_jittered)
sizes = top10.count .* 10  # Tailles des bulles
colors = rand(n)
labels = top10.track_name  # Textes à afficher
labels = coalesce.(top10.track_name, "")

# Anti-chevauchement des bulles
jitter_strength = .05
x_jittered = x .+ jitter_strength .* randn(n) .* sqrt.(sizes ./ maximum(sizes))
y_jittered = y .+ jitter_strength .* randn(n) .* sqrt.(sizes ./ maximum(sizes))

# -----------------------
# Figure
# -----------------------
fig = Figure(resolution = (800, 600))
ax = Axis(
    fig[1, 1],
    title = "Top musiques",
    xlabel = "",
    ylabel = ""
)

# -----------------------
# Scatter (bulles)
# -----------------------
scatter!(
    ax,
    positions;
    markersize = sizes,
    color = colors,
    colormap = :viridis,
    strokewidth = 0.8,
    strokecolor = :black
)

# -----------------------
# Textes centrés dans les bulles
# -----------------------


text!(
    ax,
    positions;
    text = labels,
    font = "bold",
    align = (:center, :center),
    fontsize = 12,
    color = :black
)


fig

```
Le bubble plot est sensé empecher les bulles de se chevaucher mais ça marche pas.
# Statistiques sur les artistes

## 1. Nombre d'artistes écoutés

```julia (editor=true, logging=false, output=true)
length(df.artist)
```
## 2. Top artistes (annuel et mensuel avec bubble chart)

Nombre de titres écoutés par artiste

```julia (editor=true, logging=false, output=true)
#compter pour chaque artiste le nombre d'écoutes
df_artist_counts = combine(groupby(df, :artist), nrow => :count)
#trier par nombre d'écoutes décroissant
sort!(df_artist_counts, :count, rev=true)
#sélectionner les 10 artistes les plus écoutés
top10_artists = df_artist_counts[1:10, :]
```
Variante Top artistes par temps d'écoute (en minutes)

```julia (editor=true, logging=false, output=true)
top10_artists_time =
    combine(groupby(df, :artist),
            :ms_played => sum => :total_time) |>
    df -> transform(df, :total_time => ByRow(x -> x / 60000) => :total_time_min) |>
    df -> sort(df, :total_time_min, rev = true) |>
    df -> df[1:10, :]
top10_artists_time
```
